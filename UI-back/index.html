<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>用户偏好信息</title>

		<!-- 引入 Bootstrap CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" />

		<!-- 引入 Vue 和 Axios -->
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
		<!-- 引入 Sortable.js -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

		<style>
			/* 拖动时的视觉反馈 */
			.dragging {
				background-color: #f0f0f0;
				cursor: grabbing;
			}
		</style>
	</head>
	<body>
		<div id="app" class="container mt-5">
			<h1 class="text-center mb-4">用户偏好信息</h1>

			<!-- 用户输入ID -->
			<div class="mb-4">
				<label for="userId" class="form-label">用户ID:</label>
				<div class="input-group">
					<input type="text" id="userId" class="form-control" v-model="userIdString" placeholder="请输入用户ID" />
					<button @click="fetchUserPreferences" class="btn btn-primary ms-2">
						获取用户信息
					</button>
				</div>
			</div>

			<!-- 偏好表单 -->
			<form v-if="userExists" @submit.prevent="submitPreferences">
				<!-- 拖动排序的表单项 -->
				<div class="mb-3">
					<ul id="sortableList" class="list-group">
						<li v-for="(field, index) in formFields" :key="field.name + index" class="list-group-item">
							<div class="mb-3">
								{% raw %}
								<label :for="field.name" class="form-label">{{ field.label }}</label>
								{% endraw %}
								<!-- 使用动态组件 -->
								<component :is="field.type" class="form-control" :id="field.name"
									v-model="preferences[field.model]" :placeholder="field.placeholder"
									:options="field.options" :multiple="field.multiple"></component>
							</div>
						</li>
					</ul>
				</div>

				<button type="submit" class="btn btn-success">提交偏好信息</button>
				<button @click="goToNextPage" :disabled="!isFormComplete" class="btn btn-primary">
					下一步
				</button>
			</form>

			<!-- 错误信息 -->
			<div v-if="errorMessage" class="alert alert-danger mt-3">
				{{ errorMessage }}
			</div>

			<!-- 成功提示 -->
			<div v-if="successMessage" class="alert alert-success mt-3">
				{{ successMessage }}
			</div>
		</div>

		<!-- Bootstrap JavaScript -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

		<script>
			const app = Vue.createApp({
				data() {
					return {
						userIdString: '', // 用户输入的ID (字符串形式)
						userId: null, // 用户ID (整数形式)
						preferences: {
							preferred_parking_types: [], // 用户偏好停车场类型列表
							max_parking_fee: null, // 最大停车费用
							preferred_parking_difficulty: null, // 用户偏好停车难度
							max_walking_distance: null, // 最大步行距离
							max_driving_distance: null, // 最大驾车距离
						},
						// 表单字段数据
						formFields: [{
								name: 'preferredParkingTypes',
								label: '停车场类型偏好:',
								type: 'custom-select',
								model: 'preferred_parking_types',
								options: ['商场', '地面停车场', '地下停车场', '交通枢纽'],
								multiple: true,
							},
							{
								name: 'maxParkingFee',
								label: '最大停车费用 (CNY/hour):',
								type: 'custom-input',
								model: 'max_parking_fee',
								placeholder: '请输入最大停车费',
							},
							{
								name: 'preferredParkingDifficulty',
								label: '停车难度偏好:',
								type: 'custom-select',
								model: 'preferred_parking_difficulty',
								options: ['容易', '中等', '困难'],
							},
							{
								name: 'maxWalkingDistance',
								label: '最大步行距离 (米):',
								type: 'custom-input',
								model: 'max_walking_distance',
								placeholder: '请输入最大步行距离',
							},
							{
								name: 'maxDrivingDistance',
								label: '最大驾车距离 (米):',
								type: 'custom-input',
								model: 'max_driving_distance',
								placeholder: '请输入最大驾车距离',
							},
						],
						userExists: false, // 用户是否存在
						successMessage: '', // 成功提示信息
						errorMessage: '', // 错误提示信息
					};
				},
				computed: {
					// 计算属性，用于判断表单是否填写完整
					isFormComplete() {
						const {
							preferred_parking_types,
							max_parking_fee,
							preferred_parking_difficulty,
							max_walking_distance,
							max_driving_distance,
						} = this.preferences;

						// 检查是否所有必填项都已填写
						return (
							preferred_parking_types.length > 0 &&
							max_parking_fee !== null &&
							preferred_parking_difficulty !== null &&
							max_walking_distance !== null &&
							max_driving_distance !== null
						);
					},
				},
				methods: {
					// 获取用户偏好信息
					async fetchUserPreferences() {
						this.userId = parseInt(this.userIdString);

						if (isNaN(this.userId)) {
							this.errorMessage = '请输入有效的用户ID';
							return;
						}

						this.errorMessage = '';
						this.successMessage = '';
						this.userExists = false;

						try {
							const response = await axios.get(`/user/${this.userId}`);
							const data = response.data;

							// 确保数据结构匹配
							this.preferences = {
								preferred_parking_types: data.preferred_parking_types || [],
								max_parking_fee: data.max_parking_fee || null,
								preferred_parking_difficulty: data.preferred_parking_difficulty || null,
								max_walking_distance: data.max_walking_distance || null,
								max_driving_distance: data.max_driving_distance || null,
							};

							this.userExists = true;
						} catch (error) {
							this.errorMessage = error.response ?
								error.response.data.detail :
								'无法获取用户信息';
						}
					},

					// 提交偏好信息
					async submitPreferences() {
						this.errorMessage = '';
						this.successMessage = '';

						// 获取当前字段的排序顺序
						this.formFields = this.getSortedAttributes();

						try {
							const response = await axios.put(`/user/${this.userId}`, this.preferences);
							this.successMessage = response.data.msg;
						} catch (error) {
							this.errorMessage = error.response ?
								error.response.data.detail :
								'提交偏好信息失败';
						}
					},

					// 跳转到推荐结果页面
					async goToNextPage() {
						if (this.isFormComplete) {
							await this.submitPreferences(); // 确保提交数据
							window.location.href = '/recommendation_results';
						}
					},

					// 获取当前表单字段的排序顺序
					getSortedAttributes() {
						const items = document.querySelectorAll('#sortableList li');
						return Array.from(items).map((item) => {
							return (
								this.formFields.find(
									(field) => field.label === item.querySelector('label').textContent.trim()
								) || {}
							);
						});
					},

					// 初始化拖动排序功能
					initSortable() {
						const sortableList = document.getElementById('sortableList');
						new Sortable(sortableList, {
							animation: 150,
							onStart: (evt) => {
								evt.item.classList.add('dragging');
							},
							onEnd: (evt) => {
								evt.item.classList.remove('dragging');
								this.formFields = this.getSortedAttributes();
							},
						});
					},
				},
				mounted() {
				  this.$nextTick(() => {
					this.initSortable();
				  });
				},
			});

			// 自定义输入组件
			app.component('custom-input', {
				props: ['modelValue', 'placeholder'],
				template: `
          <input type="number" :value="modelValue" @input="$emit('update:modelValue', $event.target.value)" :placeholder="placeholder" />
        `,
			});

			// 自定义选择组件
			app.component('custom-select', {
				props: ['modelValue', 'options', 'multiple'],
				template: `
                <select :multiple="multiple" v-model="selectedValue">
                  <option v-for="option in options" :key="option" :value="option">
                    {{ option }}
                  </option>
                </select>
              `,
				computed: {
					selectedValue: {
						get() {
							return this.modelValue;
						},
						set(value) {
							this.$emit('update:modelValue', value);
						}
					}
				}
			});

			// 将 Vue 应用挂载到 DOM
			app.mount('#app');
		</script>
	</body>
</html>